<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ブログ</title>
    <style>
        :root{
            --bg:#1a1a1a;
            --fg:#e0e0e0;
            --muted:#9a9a9a;
            --accent:#4aa3ff;
        }
        html,body{height:100%;}
        body{
            margin:0;
            background:var(--bg);
            color:var(--fg);
            font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing:antialiased;
            padding:24px;
            box-sizing:border-box;
        }
        a{color:var(--accent); text-decoration:underline;}
        header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
        nav a{margin-right:12px}
        main{max-width:820px}
        .meta{color:var(--muted);font-size:0.9rem;margin-bottom:12px}
        zero-md{display:block}
        /* zero-md 内のデフォルトスタイル補正 */
        zero-md ::slotted(.markdown-body){ color:var(--fg) }
    </style>
    <!-- zero-md をモジュールで読み込み -->
    <script type="module" src="https://unpkg.com/zero-md@3/dist/zero-md.min.js"></script>
</head>
<body>
    <header>
        <h1 style="margin:0;font-size:1.25rem">シンプルブログ</h1>
        <nav>
            <a href="#" data-src="./posts/test.md">posts/test.md を表示</a>
        </nav>
    </header>

    <main>
        <div class="meta">背景:#1a1a1a 文字:#e0e0e0 — zero-md で Markdown を表示します</div>

        <zero-md id="viewer" src="./posts/test.md">
            <template>
                <style>
                    :host{display:block}
                    .markdown-body{ color:var(--fg); background:transparent }
                    a{color:var(--accent)}
                </style>
            </template>
        </zero-md>

        <p class="meta">リンクをクリックすると、その場で Markdown を読み込みます。もし自動読み込みに失敗した場合は、スクリプト側で fetch して内部に挿入するフォールバックを行います。</p>
    </main>

    <script>
        (function(){
            let viewer = document.getElementById('viewer');
            const link = document.querySelector('a[data-src]');

            async function loadMarkdown(path){
                // 手動で fetch を試みる
                try{
                    const resp = await fetch(path, {cache: 'no-store'});
                    if(resp.ok){
                        const text = await resp.text();

                        // 新しい zero-md 要素を作って置換する（動的挿入時に確実にレンダリングされる）
                        const newViewer = document.createElement('zero-md');
                        newViewer.id = 'viewer';

                        const tmpl = document.createElement('template');
                        tmpl.innerHTML = `
                            <style>
                                :host{display:block}
                                .markdown-body{ color:var(--fg); background:transparent }
                                a{color:var(--accent)}
                            </style>`;

                        const s = document.createElement('script');
                        s.type = 'text/markdown';
                        s.textContent = text;

                        newViewer.appendChild(tmpl);
                        newViewer.appendChild(s);

                        viewer.parentNode.replaceChild(newViewer, viewer);
                        viewer = newViewer;
                        return;
                    }
                }catch(e){
                    // fetch に失敗したら下のフォールバックを使う
                }

                // フォールバック: zero-md に src をセットして内部ローダーに任せる
                if(viewer) viewer.setAttribute('src', path);
            }

            // 初期表示
            loadMarkdown('./posts/test.md');

            // リンククリックで動的にロード
            link.addEventListener('click', function(e){
                e.preventDefault();
                const p = this.getAttribute('data-src');
                if(p) loadMarkdown(p);
            });
        })();
    </script>
</body>
</html>